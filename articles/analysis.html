<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Time-to-event data analysis with the bmstate package • bmstate</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Time-to-event data analysis with the bmstate package">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">bmstate</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.8</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/analysis.html">Time-to-event data analysis with the bmstate package</a></li>
    <li><a class="dropdown-item" href="../articles/exposure-hazard.html">Exposure-hazard multistate modeling with bmstate</a></li>
    <li><a class="dropdown-item" href="../articles/math.html">Mathematical description of models in the bmstate package</a></li>
    <li><a class="dropdown-item" href="../articles/survival.html">Survival data analysis with the bmstate package</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Time-to-event data analysis with the bmstate package</h1>
                        <h4 data-toc-skip class="author">Juho
Timonen</h4>
            
            <h4 data-toc-skip class="date">4th Nov 2025</h4>
      

      <div class="d-none name"><code>analysis.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://generable.github.io/bmstate/">bmstate</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Attached bmstate 0.2.8. Type ?bmstate to get started.</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'dplyr'</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     filter, lag</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:base':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     intersect, setdiff, setequal, union</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mjskay.github.io/ggdist/" class="external-link">ggdist</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/get_theme.html" class="external-link">theme_set</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="data">Data<a class="anchor" aria-label="anchor" href="#data"></a>
</h2>
<div class="section level3">
<h3 id="data-preprocessing">Data preprocessing<a class="anchor" aria-label="anchor" href="#data-preprocessing"></a>
</h3>
<p>Here we analyse the <code>cav</code> data from the <code>msm</code>
package. It is a Cardiac Allograft Vasculopathy (CAV) data set of 622
heart transplant recipients. They are observed either in state 1 (No
CAV), state 2 (Mild CAV), state 3 (Severe CAV), or state 4 (Dead).</p>
<p>First we modify the original data like <a href="https://rviews.rstudio.com/2023/04/19/multistate-models-for-medical-applications/" class="external-link">here</a>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df_full</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="fu">msm</span><span class="fu">::</span><span class="va"><a href="https://chjackson.github.io/msm/reference/cav.html" class="external-link">cav</a></span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">PTNUM</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    min_age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">age</span><span class="op">)</span>,</span>
<span>    state <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cummax</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">df_full</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 11</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Groups:   PTNUM [1]</span></span></span>
<span><span class="co">#&gt;    PTNUM   age years  dage   sex pdiag cumrej state firstobs statemax min_age</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> <span style="text-decoration: underline;">100</span>002  52.5  0       21     0 IHD        0     1        1        1    52.5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> <span style="text-decoration: underline;">100</span>002  53.5  1.00    21     0 IHD        2     1        0        1    52.5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> <span style="text-decoration: underline;">100</span>002  54.5  2.00    21     0 IHD        2     2        0        2    52.5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> <span style="text-decoration: underline;">100</span>002  55.6  3.09    21     0 IHD        2     2        0        2    52.5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> <span style="text-decoration: underline;">100</span>002  56.5  4       21     0 IHD        3     2        0        2    52.5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> <span style="text-decoration: underline;">100</span>002  57.5  5.00    21     0 IHD        3     3        0        3    52.5</span></span></code></pre></div>
<p>This is snapshot data of the state at given time rather than exactly
observed transition times. Only the death times are exact. We make an
assumption that all state transitions happen exactly at the first time
the new state is seen in the data.</p>
<p>We select only needed columns and rename them. In our resulting data
frame, we will have columns</p>
<ul>
<li>
<code>time</code>: time since transplant (in years)</li>
<li>
<code>age</code>: age of the patient at transplant time</li>
<li>
<code>dage</code>: age of the donor</li>
<li>
<code>sex</code>: 0 or 1</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df_full</span><span class="op">$</span><span class="va">PTNUM</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">df_full</span><span class="op">$</span><span class="va">PTNUM</span><span class="op">)</span></span>
<span><span class="va">df_snapshots</span> <span class="op">&lt;-</span> <span class="va">df_full</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">PTNUM</span>, <span class="va">state</span>, <span class="va">years</span>, <span class="va">min_age</span>, <span class="va">dage</span>, <span class="va">sex</span><span class="op">)</span></span>
<span><span class="va">df_snapshots</span> <span class="op">&lt;-</span> <span class="va">df_snapshots</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span></span>
<span>  subject_id <span class="op">=</span> <span class="va">PTNUM</span>,</span>
<span>  age <span class="op">=</span> <span class="va">min_age</span>,</span>
<span>  time <span class="op">=</span> <span class="va">years</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">df_snapshots</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 6</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Groups:   subject_id [1]</span></span></span>
<span><span class="co">#&gt;   subject_id state  time   age  dage   sex</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 100002         1  0     52.5    21     0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> 100002         1  1.00  52.5    21     0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> 100002         2  2.00  52.5    21     0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> 100002         2  3.09  52.5    21     0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> 100002         2  4     52.5    21     0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> 100002         3  5.00  52.5    21     0</span></span></code></pre></div>
<p>We remove the unnecessary snapshot rows that are not needed after
making the simplifying assumption.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df_state_changes</span> <span class="op">&lt;-</span> <span class="va">df_snapshots</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">subject_id</span>, <span class="va">time</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">subject_id</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    .first <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html" class="external-link">row_number</a></span><span class="op">(</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span>,</span>
<span>    .last  <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html" class="external-link">row_number</a></span><span class="op">(</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    .chg   <span class="op">=</span> <span class="va">state</span> <span class="op">!=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lag</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span> <span class="co"># TRUE at the first row of each new state run</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">.first</span> <span class="op">|</span> <span class="va">.last</span> <span class="op">|</span> <span class="va">.chg</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lag</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># keep first, last, and changes</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">.first</span>, <span class="op">-</span><span class="va">.last</span>, <span class="op">-</span><span class="va">.chg</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Every row is a transition but the first</span></span>
<span><span class="va">df_state_changes</span> <span class="op">&lt;-</span> <span class="va">df_state_changes</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">subject_id</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>is_transition <span class="op">=</span> <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/replace_na.html" class="external-link">replace_na</a></span><span class="op">(</span><span class="va">state</span> <span class="op">!=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lag</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span>, <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">df_state_changes</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 7</span></span></span>
<span><span class="co">#&gt;   subject_id state  time   age  dage   sex is_transition</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span>        </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 100002         1  0     52.5    21     0 FALSE        </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> 100002         2  2.00  52.5    21     0 TRUE         </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> 100002         3  5.00  52.5    21     0 TRUE         </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> 100002         4  5.85  52.5    21     0 TRUE         </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> 100003         1  0     29.5    17     0 FALSE        </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> 100003         3  2.01  29.5    17     0 TRUE</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="transition-matrix">Transition matrix<a class="anchor" aria-label="anchor" href="#transition-matrix"></a>
</h3>
<p>We use the following transition matrix, which is built into the
package.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/transmat.html">transmat_progression</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">tm</span></span>
<span><span class="co">#&gt;         Healthy Mild Severe Dead</span></span>
<span><span class="co">#&gt; Healthy       0    1      1    1</span></span>
<span><span class="co">#&gt; Mild          0    0      1    1</span></span>
<span><span class="co">#&gt; Severe        0    0      0    1</span></span>
<span><span class="co">#&gt; Dead          0    0      0    0</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="the-pathdata-format">The PathData format<a class="anchor" aria-label="anchor" href="#the-pathdata-format"></a>
</h3>
<p>We format the data as <code>PathData</code>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">covs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"age"</span>, <span class="st">"dage"</span>, <span class="st">"sex"</span><span class="op">)</span></span>
<span><span class="va">pd</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/df_to_pathdata.html">df_to_pathdata</a></span><span class="op">(</span><span class="va">df_state_changes</span>, <span class="va">tm</span>, <span class="va">covs</span><span class="op">)</span></span>
<span><span class="va">pd</span></span>
<span><span class="co">#&gt; PathData object with 622 paths</span></span>
<span><span class="co">#&gt;  * States = {Healthy, Mild, Severe, Dead}</span></span>
<span><span class="co">#&gt;  * Covariates = {age, dage, sex}</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="analysis">Analysis<a class="anchor" aria-label="anchor" href="#analysis"></a>
</h2>
<div class="section level3">
<h3 id="fitting-a-model">Fitting a model<a class="anchor" aria-label="anchor" href="#fitting-a-model"></a>
</h3>
<p>We create a model and set the spline knot locations based on
quantiles of the observed transition times.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># MSM</span></span>
<span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_msm.html">create_msm</a></span><span class="op">(</span><span class="va">tm</span>,</span>
<span>  hazard_covs <span class="op">=</span> <span class="va">covs</span>,</span>
<span>  n_grid <span class="op">=</span> <span class="fl">10000</span>,</span>
<span>  t_max <span class="op">=</span> <span class="fl">20</span></span>
<span><span class="op">)</span></span>
<span><span class="va">t_trans</span> <span class="op">&lt;-</span> <span class="va">pd</span><span class="op">$</span><span class="fu">transition_times</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">mod</span><span class="op">$</span><span class="fu">set_knots</span><span class="op">(</span>t_max <span class="op">=</span> <span class="fl">20</span>, t_event <span class="op">=</span> <span class="va">t_trans</span>, num_knots <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">mod</span><span class="op">$</span><span class="fu">get_knots</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1]  0.000000  4.980822 20.000000</span></span></code></pre></div>
<p>We fit the model by optimizing.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_stan.html">fit_stan</a></span><span class="op">(</span><span class="va">mod</span>, data <span class="op">=</span> <span class="va">pd</span>, method <span class="op">=</span> <span class="st">"optimize"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Using stan file at /home/runner/work/_temp/Library/bmstate/stan/msm.stan</span></span>
<span><span class="co">#&gt; Initial log joint probability = -362803 </span></span>
<span><span class="co">#&gt;     Iter      log prob        ||dx||      ||grad||       alpha      alpha0  # evals  Notes  </span></span>
<span><span class="co">#&gt; Error evaluating model log probability: Non-finite gradient. </span></span>
<span><span class="co">#&gt; Error evaluating model log probability: Non-finite gradient. </span></span>
<span><span class="co">#&gt; Error evaluating model log probability: Non-finite gradient. </span></span>
<span><span class="co">#&gt; Error evaluating model log probability: Non-finite gradient. </span></span>
<span><span class="co">#&gt;       99      -1859.49     0.0281839       13.4581           1           1      121    </span></span>
<span><span class="co">#&gt;     Iter      log prob        ||dx||      ||grad||       alpha      alpha0  # evals  Notes  </span></span>
<span><span class="co">#&gt;      199      -1858.05     0.0152368       1.88641           1           1      227    </span></span>
<span><span class="co">#&gt;     Iter      log prob        ||dx||      ||grad||       alpha      alpha0  # evals  Notes  </span></span>
<span><span class="co">#&gt;      299      -1857.87    0.00716934       2.13723           1           1      338    </span></span>
<span><span class="co">#&gt;     Iter      log prob        ||dx||      ||grad||       alpha      alpha0  # evals  Notes  </span></span>
<span><span class="co">#&gt;      399      -1857.79    0.00653108       1.98944      0.1595           1      449    </span></span>
<span><span class="co">#&gt;     Iter      log prob        ||dx||      ||grad||       alpha      alpha0  # evals  Notes  </span></span>
<span><span class="co">#&gt;      499      -1857.74    0.00123761      0.191422           1           1      556    </span></span>
<span><span class="co">#&gt;     Iter      log prob        ||dx||      ||grad||       alpha      alpha0  # evals  Notes  </span></span>
<span><span class="co">#&gt;      599      -1857.72     0.0095713      0.502378           1           1      663    </span></span>
<span><span class="co">#&gt;     Iter      log prob        ||dx||      ||grad||       alpha      alpha0  # evals  Notes  </span></span>
<span><span class="co">#&gt;      699      -1857.71    0.00255015      0.596568           1           1      772    </span></span>
<span><span class="co">#&gt;     Iter      log prob        ||dx||      ||grad||       alpha      alpha0  # evals  Notes  </span></span>
<span><span class="co">#&gt;      799      -1857.69   0.000664024      0.230892           1           1      880    </span></span>
<span><span class="co">#&gt;     Iter      log prob        ||dx||      ||grad||       alpha      alpha0  # evals  Notes  </span></span>
<span><span class="co">#&gt;      841      -1857.69   0.000797173     0.0860521           1           1      924    </span></span>
<span><span class="co">#&gt; Optimization terminated normally:  </span></span>
<span><span class="co">#&gt;   Convergence detected: relative gradient magnitude is below tolerance </span></span>
<span><span class="co">#&gt; Finished in  3.8 seconds.</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="inferred-baseline-hazards">Inferred baseline hazards<a class="anchor" aria-label="anchor" href="#inferred-baseline-hazards"></a>
</h3>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plt</span> <span class="op">&lt;-</span> <span class="va">fit</span><span class="op">$</span><span class="fu">plot_h0</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">plt</span></span></code></pre></div>
<p><img src="analysis_files/figure-html/unnamed-chunk-9-1.png" class="r-plt" width="672"></p>
</div>
<div class="section level3">
<h3 id="inferred-covariate-effects">Inferred covariate effects<a class="anchor" aria-label="anchor" href="#inferred-covariate-effects"></a>
</h3>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span><span class="op">$</span><span class="fu">covariate_effects</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;   covariate         beta target_state_idx target_state</span></span>
<span><span class="co">#&gt; 1       age -0.0089 ± NA                2         Mild</span></span>
<span><span class="co">#&gt; 2       age -0.0559 ± NA                3       Severe</span></span>
<span><span class="co">#&gt; 3       age  0.3135 ± NA                4         Dead</span></span>
<span><span class="co">#&gt; 4      dage  0.3429 ± NA                2         Mild</span></span>
<span><span class="co">#&gt; 5      dage  0.0458 ± NA                3       Severe</span></span>
<span><span class="co">#&gt; 6      dage  0.1009 ± NA                4         Dead</span></span>
<span><span class="co">#&gt; 7       sex -0.1583 ± NA                2         Mild</span></span>
<span><span class="co">#&gt; 8       sex -0.0761 ± NA                3       Severe</span></span>
<span><span class="co">#&gt; 9       sex  0.1411 ± NA                4         Dead</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="state-occupancy-probabilities">State occupancy probabilities<a class="anchor" aria-label="anchor" href="#state-occupancy-probabilities"></a>
</h3>
<p>For each subject, we compute the probability that they are in a given
state at time
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p_state_df</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">fit</span>, <span class="va">oos</span>, <span class="va">data</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/p_state_occupancy.html">p_state_occupancy</a></span><span class="op">(</span><span class="va">fit</span>, data <span class="op">=</span> <span class="va">data</span>, oos <span class="op">=</span> <span class="va">oos</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">data</span> <span class="op">&lt;-</span> <span class="va">fit</span><span class="op">$</span><span class="va">data</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">paths</span><span class="op">$</span><span class="va">subject_df</span>, by <span class="op">=</span> <span class="st">"subject_id"</span><span class="op">)</span></span>
<span>  <span class="va">df</span><span class="op">$</span><span class="va">State</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">state_idx</span>, <span class="st">": "</span>, <span class="va">df</span><span class="op">$</span><span class="va">state</span><span class="op">)</span></span>
<span>  <span class="va">df</span><span class="op">$</span><span class="va">sex</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">sex</span><span class="op">)</span></span>
<span>  <span class="va">df</span></span>
<span><span class="op">}</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">p_state_df</span><span class="op">(</span><span class="va">fit</span>, oos <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Recompiling Stan model</span></span>
<span><span class="co">#&gt; Using stan file at /home/runner/work/_temp/Library/bmstate/stan/msm.stan</span></span>
<span><span class="co">#&gt; ar: creating stan/lib/stan_math/lib/sundials_6.1.1/lib/libsundials_nvecserial.a</span></span>
<span><span class="co">#&gt; ar: creating stan/lib/stan_math/lib/sundials_6.1.1/lib/libsundials_cvodes.a</span></span>
<span><span class="co">#&gt; ar: creating stan/lib/stan_math/lib/sundials_6.1.1/lib/libsundials_idas.a</span></span>
<span><span class="co">#&gt; ar: creating stan/lib/stan_math/lib/sundials_6.1.1/lib/libsundials_kinsol.a</span></span>
<span><span class="co">#&gt; /home/runner/.cmdstan/cmdstan-2.37.0/stan/lib/stan_math/lib/tbb_2020.3/build/Makefile.tbb:28: CONFIG: cfg=release arch=intel64 compiler=gcc target=linux runtime=cc13.3.0_libc2.39_kernel6.11.0</span></span>
<span><span class="co">#&gt; In file included from ../tbb_2020.3/src/tbb/concurrent_hash_map.cpp:17:</span></span>
<span><span class="co">#&gt; ../tbb_2020.3/include/tbb/concurrent_hash_map.h:347:23: warning: ‘template&lt;class _Category, class _Tp, class _Distance, class _Pointer, class _Reference&gt; struct std::iterator’ is deprecated [-Wdeprecated-declarations]</span></span>
<span><span class="co">#&gt;   347 |         : public std::iterator&lt;std::forward_iterator_tag,Value&gt;</span></span>
<span><span class="co">#&gt;       |                       ^~~~~~~~</span></span>
<span><span class="co">#&gt; In file included from /usr/include/c++/13/bits/stl_construct.h:61,</span></span>
<span><span class="co">#&gt;                  from /usr/include/c++/13/bits/stl_tempbuf.h:61,</span></span>
<span><span class="co">#&gt;                  from /usr/include/c++/13/memory:66,</span></span>
<span><span class="co">#&gt;                  from ../tbb_2020.3/include/tbb/tbb_stddef.h:452,</span></span>
<span><span class="co">#&gt;                  from ../tbb_2020.3/include/tbb/concurrent_hash_map.h:23:</span></span>
<span><span class="co">#&gt; /usr/include/c++/13/bits/stl_iterator_base_types.h:127:34: note: declared here</span></span>
<span><span class="co">#&gt;   127 |     struct _GLIBCXX17_DEPRECATED iterator</span></span>
<span><span class="co">#&gt;       |                                  ^~~~~~~~</span></span>
<span><span class="co">#&gt; cc1plus: note: unrecognized command-line option ‘-Wno-unknown-warning-option’ may have been intended to silence earlier diagnostics</span></span>
<span><span class="co">#&gt; In file included from ../tbb_2020.3/src/tbb/concurrent_queue.cpp:22:</span></span>
<span><span class="co">#&gt; ../tbb_2020.3/include/tbb/internal/_concurrent_queue_impl.h:749:21: warning: ‘template&lt;class _Category, class _Tp, class _Distance, class _Pointer, class _Reference&gt; struct std::iterator’ is deprecated [-Wdeprecated-declarations]</span></span>
<span><span class="co">#&gt;   749 |         public std::iterator&lt;std::forward_iterator_tag,Value&gt; {</span></span>
<span><span class="co">#&gt;       |                     ^~~~~~~~</span></span>
<span><span class="co">#&gt; In file included from /usr/include/c++/13/bits/stl_construct.h:61,</span></span>
<span><span class="co">#&gt;                  from /usr/include/c++/13/bits/stl_tempbuf.h:61,</span></span>
<span><span class="co">#&gt;                  from /usr/include/c++/13/memory:66,</span></span>
<span><span class="co">#&gt;                  from ../tbb_2020.3/include/tbb/tbb_stddef.h:452,</span></span>
<span><span class="co">#&gt;                  from ../tbb_2020.3/src/tbb/concurrent_queue.cpp:17:</span></span>
<span><span class="co">#&gt; /usr/include/c++/13/bits/stl_iterator_base_types.h:127:34: note: declared here</span></span>
<span><span class="co">#&gt;   127 |     struct _GLIBCXX17_DEPRECATED iterator</span></span>
<span><span class="co">#&gt;       |                                  ^~~~~~~~</span></span>
<span><span class="co">#&gt; ../tbb_2020.3/include/tbb/internal/_concurrent_queue_impl.h:1013:21: warning: ‘template&lt;class _Category, class _Tp, class _Distance, class _Pointer, class _Reference&gt; struct std::iterator’ is deprecated [-Wdeprecated-declarations]</span></span>
<span><span class="co">#&gt;  1013 |         public std::iterator&lt;std::forward_iterator_tag,Value&gt; {</span></span>
<span><span class="co">#&gt;       |                     ^~~~~~~~</span></span>
<span><span class="co">#&gt; /usr/include/c++/13/bits/stl_iterator_base_types.h:127:34: note: declared here</span></span>
<span><span class="co">#&gt;   127 |     struct _GLIBCXX17_DEPRECATED iterator</span></span>
<span><span class="co">#&gt;       |                                  ^~~~~~~~</span></span>
<span><span class="co">#&gt; cc1plus: note: unrecognized command-line option ‘-Wno-unknown-warning-option’ may have been intended to silence earlier diagnostics</span></span>
<span><span class="co">#&gt; calling solve_trans_prob_matrix 622 x 1 times</span></span></code></pre></div>
<p>We plot the state occupancy probabilities, coloring by different
covariate values.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Plot by age</span></span>
<span><span class="va">plt_age</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">prob</span><span class="op">)</span>, group <span class="op">=</span> <span class="va">subject_id</span>, color <span class="op">=</span> <span class="va">age</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="va">.</span> <span class="op">~</span> <span class="va">State</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_color_viridis_c</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"State probability"</span><span class="op">)</span></span>
<span><span class="va">plt_age</span></span></code></pre></div>
<p><img src="analysis_files/figure-html/unnamed-chunk-12-1.png" class="r-plt" width="672"></p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># By sex</span></span>
<span><span class="va">df_bysex</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">State</span>, <span class="va">time</span>, <span class="va">sex</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>p_mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">prob</span><span class="op">)</span><span class="op">)</span>, .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span></span>
<span><span class="va">plt_sex</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">df_bysex</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time</span>, y <span class="op">=</span> <span class="va">p_mean</span>, group <span class="op">=</span> <span class="va">sex</span>, color <span class="op">=</span> <span class="va">sex</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="va">.</span> <span class="op">~</span> <span class="va">State</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Mean state probability"</span><span class="op">)</span></span>
<span><span class="va">plt_sex</span></span></code></pre></div>
<p><img src="analysis_files/figure-html/unnamed-chunk-13-1.png" class="r-plt" width="672"></p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># By donor age</span></span>
<span><span class="va">plt_dage</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">prob</span><span class="op">)</span>, group <span class="op">=</span> <span class="va">subject_id</span>, color <span class="op">=</span> <span class="va">dage</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="va">.</span> <span class="op">~</span> <span class="va">State</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_color_viridis_c</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"State probability"</span><span class="op">)</span></span>
<span><span class="va">plt_dage</span></span></code></pre></div>
<p><img src="analysis_files/figure-html/unnamed-chunk-14-1.png" class="r-plt" width="672"></p>
</div>
<div class="section level3">
<h3 id="predicting-for-a-new-subject">Predicting for a new subject<a class="anchor" aria-label="anchor" href="#predicting-for-a-new-subject"></a>
</h3>
<p>Here is a function for creating test data for a new subject with
given covariates and given state at time 0.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">create_test_subject</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">state</span>, <span class="va">dages</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">30</span>, <span class="fl">40</span>, <span class="fl">50</span>, <span class="fl">60</span>, <span class="fl">70</span>, <span class="fl">80</span><span class="op">)</span>, <span class="va">age</span> <span class="op">=</span> <span class="fl">60</span>, <span class="va">sex</span> <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">pdf</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span>  <span class="va">sdf</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span>  <span class="va">ldf</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span>  <span class="va">j</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">dage</span> <span class="kw">in</span> <span class="va">dages</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">j</span> <span class="op">&lt;-</span> <span class="va">j</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>    <span class="va">sid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"test-"</span>, <span class="va">dage</span><span class="op">)</span></span>
<span>    <span class="va">pdf_j</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>path_id <span class="op">=</span> <span class="va">j</span>, state <span class="op">=</span> <span class="va">state</span>, time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">20</span><span class="op">)</span>, trans_idx <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">sdf_j</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>subject_id <span class="op">=</span> <span class="va">sid</span>, age <span class="op">=</span> <span class="va">age</span>, dage <span class="op">=</span> <span class="va">dage</span>, sex <span class="op">=</span> <span class="va">sex</span><span class="op">)</span></span>
<span>    <span class="va">ldf_j</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>path_id <span class="op">=</span> <span class="va">j</span>, draw_idx <span class="op">=</span> <span class="fl">1</span>, rep_idx <span class="op">=</span> <span class="fl">1</span>, subject_id <span class="op">=</span> <span class="va">sid</span><span class="op">)</span></span>
<span>    <span class="va">pdf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">pdf</span>, <span class="va">pdf_j</span><span class="op">)</span></span>
<span>    <span class="va">ldf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">ldf</span>, <span class="va">ldf_j</span><span class="op">)</span></span>
<span>    <span class="va">sdf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">sdf</span>, <span class="va">sdf_j</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">pd</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/PathData.html">PathData</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">sdf</span>, <span class="va">pdf</span>, <span class="va">ldf</span>, <span class="va">fit</span><span class="op">$</span><span class="va">model</span><span class="op">$</span><span class="va">system</span><span class="op">$</span><span class="fu">tm</span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"age"</span>, <span class="st">"dage"</span>, <span class="st">"sex"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va"><a href="../reference/JointData.html">JointData</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>paths <span class="op">=</span> <span class="va">pd</span>, dosing <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We can use it like this to predict the state occupancy probabilities
for the same 60 years old subject with sex 0, considering what if they
got the transplant from a donor of given age.</p>
<div class="section level4">
<h4 id="starting-healthy">Starting healthy<a class="anchor" aria-label="anchor" href="#starting-healthy"></a>
</h4>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat_test</span> <span class="op">&lt;-</span> <span class="fu">create_test_subject</span><span class="op">(</span>state <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">df_test</span> <span class="op">&lt;-</span> <span class="fu">p_state_df</span><span class="op">(</span><span class="va">fit</span>, data <span class="op">=</span> <span class="va">dat_test</span>, oos <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; calling solve_trans_prob_matrix 7 x 1 times</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">df_test</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">prob</span><span class="op">)</span>, group <span class="op">=</span> <span class="va">subject_id</span>, color <span class="op">=</span> <span class="va">dage</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="va">.</span> <span class="op">~</span> <span class="va">State</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_color_viridis_c</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"State probability"</span><span class="op">)</span></span></code></pre></div>
<p><img src="analysis_files/figure-html/unnamed-chunk-16-1.png" class="r-plt" width="672"></p>
</div>
<div class="section level4">
<h4 id="starting-from-mild-cav">Starting from Mild CAV<a class="anchor" aria-label="anchor" href="#starting-from-mild-cav"></a>
</h4>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat_test</span> <span class="op">&lt;-</span> <span class="fu">create_test_subject</span><span class="op">(</span>state <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">df_test</span> <span class="op">&lt;-</span> <span class="fu">p_state_df</span><span class="op">(</span><span class="va">fit</span>, data <span class="op">=</span> <span class="va">dat_test</span>, oos <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; calling solve_trans_prob_matrix 7 x 1 times</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">df_test</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">prob</span><span class="op">)</span>, group <span class="op">=</span> <span class="va">subject_id</span>, color <span class="op">=</span> <span class="va">dage</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="va">.</span> <span class="op">~</span> <span class="va">State</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_color_viridis_c</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"State probability"</span><span class="op">)</span></span></code></pre></div>
<p><img src="analysis_files/figure-html/unnamed-chunk-17-1.png" class="r-plt" width="672"></p>
</div>
<div class="section level4">
<h4 id="starting-from-severe-cav">Starting from Severe CAV<a class="anchor" aria-label="anchor" href="#starting-from-severe-cav"></a>
</h4>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat_test</span> <span class="op">&lt;-</span> <span class="fu">create_test_subject</span><span class="op">(</span>state <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">df_test</span> <span class="op">&lt;-</span> <span class="fu">p_state_df</span><span class="op">(</span><span class="va">fit</span>, data <span class="op">=</span> <span class="va">dat_test</span>, oos <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; calling solve_trans_prob_matrix 7 x 1 times</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">df_test</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">prob</span><span class="op">)</span>, group <span class="op">=</span> <span class="va">subject_id</span>, color <span class="op">=</span> <span class="va">dage</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="va">.</span> <span class="op">~</span> <span class="va">State</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_color_viridis_c</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"State probability"</span><span class="op">)</span></span></code></pre></div>
<p><img src="analysis_files/figure-html/unnamed-chunk-18-1.png" class="r-plt" width="672"></p>
</div>
</div>
<div class="section level3">
<h3 id="generating-paths">Generating paths<a class="anchor" aria-label="anchor" href="#generating-paths"></a>
</h3>
<p>We simulate state paths for a single subject using the fit.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat_test</span> <span class="op">&lt;-</span> <span class="va">pd</span><span class="op">$</span><span class="fu">filter</span><span class="op">(</span><span class="va">pd</span><span class="op">$</span><span class="va">subject_df</span><span class="op">$</span><span class="va">subject_id</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">pg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_paths.html">generate_paths</a></span><span class="op">(</span><span class="va">fit</span>, oos <span class="op">=</span> <span class="cn">TRUE</span>, data <span class="op">=</span> <span class="va">dat_test</span>, n_rep <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span></span>
<span><span class="co">#&gt; Computing hazard multipliers and getting state vector at t_start</span></span>
<span><span class="co">#&gt; Generating paths</span></span>
<span><span class="co">#&gt; Generating 1000 paths</span></span></code></pre></div>
<p>We compute the 20-year state visit probabilities.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/p_state_visit_per_subject.html">p_state_visit_per_subject</a></span><span class="op">(</span><span class="va">pg</span>, <span class="st">"Mild"</span><span class="op">)</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/p_state_visit_per_subject.html">p_state_visit_per_subject</a></span><span class="op">(</span><span class="va">pg</span>, <span class="st">"Severe"</span><span class="op">)</span></span>
<span><span class="va">p3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/p_state_visit_per_subject.html">p_state_visit_per_subject</a></span><span class="op">(</span><span class="va">pg</span>, <span class="st">"Dead"</span><span class="op">)</span></span>
<span><span class="va">psv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">p1</span>, <span class="va">p2</span>, <span class="va">p3</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">pg</span><span class="op">$</span><span class="va">subject_df</span>, by <span class="op">=</span> <span class="st">"subject_id"</span><span class="op">)</span></span>
<span><span class="va">psv</span></span>
<span><span class="co">#&gt;   subject_id  prob      age dage sex</span></span>
<span><span class="co">#&gt; 1     100002 0.519 52.49589   21   0</span></span>
<span><span class="co">#&gt; 2     100002 0.265 52.49589   21   0</span></span>
<span><span class="co">#&gt; 3     100002 0.990 52.49589   21   0</span></span></code></pre></div>
<p>We can study the death event time distribution for this subject.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">td</span> <span class="op">&lt;-</span> <span class="va">pg</span><span class="op">$</span><span class="fu">as_transitions</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">trans_idx</span> <span class="op">&gt;</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">to</span> <span class="op">==</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">td</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://mjskay.github.io/ggdist/reference/stat_halfeye.html" class="external-link">stat_halfeye</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Death time"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Density"</span><span class="op">)</span></span></code></pre></div>
<p><img src="analysis_files/figure-html/unnamed-chunk-21-1.png" class="r-plt" width="576"></p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Juho Timonen, Generable.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
