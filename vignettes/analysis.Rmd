---
title: "Time-to-event data analysis with the bmstate package"
author: Juho Timonen
date: 4th Nov 2025
output: 
  rmarkdown::html_vignette:
    toc: true 
    toc_depth: 3
    number_sections: true
    
bibliography: references.bib
editor: source
vignette: >
  %\VignetteIndexEntry{Time-to-event data analysis with the bmstate package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(bmstate)
library(ggplot2)
library(dplyr)
library(tidyr)
theme_set(theme_minimal())
theme_set(theme_bw())
```

# Data

## Data preprocessing

Here we analyse the `cav` data from the `msm` package. It is a Cardiac Allograft Vasculopathy (CAV) data set of 622 heart transplant recipients. They are observed
either in state 1 (No CAV), state 2 (Mild CAV), state 3 (Severe CAV),
or state 4 (Dead).

First we modify the original data like [here](https://rviews.rstudio.com/2023/04/19/multistate-models-for-medical-applications/).

```{r}
df_full <- as_tibble(msm::cav) |>
  group_by(PTNUM) |>
  mutate(
    min_age = min(age),
    state = cummax(state)
  )
head(df_full)
```

This is snapshot data of the state at given time rather than exactly observed
transition times. Only the death times are exact. We make an assumption that
all state transitions happen exactly at the first time the new state is seen
in the data.

We select only needed columns and rename them. In our resulting data frame,
we will have columns 

* `time`: time since transplant (in years) 
* `age`: age of the patient at transplant time 
* `dage`: age of the donor
* `sex`: 0 or 1

```{r}
df_full$PTNUM <- as.character(df_full$PTNUM)
df_snapshots <- df_full |> select(PTNUM, state, years, min_age, dage, sex)
df_snapshots <- df_snapshots |> rename(
  subject_id = PTNUM,
  age = min_age,
  time = years
)
head(df_snapshots)
```

We remove the unnecessary snapshot rows that are not needed after
making the simplifying assumption.

```{r}
df_state_changes <- df_snapshots |>
  arrange(subject_id, time) |>
  group_by(subject_id) |>
  mutate(
    .first = row_number() == 1,
    .last  = row_number() == n(),
    .chg   = state != lag(state) # TRUE at the first row of each new state run
  ) |>
  filter(.first | .last | .chg | is.na(lag(state))) |> # keep first, last, and changes
  select(-.first, -.last, -.chg) |>
  ungroup()

# Every row is a transition but the first
df_state_changes <- df_state_changes |>
  group_by(subject_id) |>
  mutate(is_transition = tidyr::replace_na(state != lag(state), FALSE)) |>
  ungroup()
head(df_state_changes)
```

## Transition matrix

We use the following transition matrix, which is built into the package.

```{r}
tm <- transmat_progression()
tm
```

## The PathData format

We format the data as `PathData`.

```{r}
covs <- c("age", "dage", "sex")
pd <- df_to_pathdata(df_state_changes, tm, covs)
pd
```

# Analysis

## Fitting a model

We create a model and set the spline knot locations based on quantiles of
the observed transition times.

```{r}
# MSM
mod <- create_msm(tm,
  hazard_covs = covs,
  n_grid = 10000,
  t_max = 20
)
t_trans <- pd$transition_times()
mod$set_knots(t_max = 20, t_event = t_trans, num_knots = 3)
mod$get_knots()
```

We fit the model by optimizing.

```{r}
fit <- fit_stan(mod, data = pd, method = "optimize")
```

## Inferred baseline hazards

```{r, fig.width=7, fig.height=4}
plt <- fit$plot_h0()
plt
```

## Inferred covariate effects

```{r, fig.width=7, fig.height=4}
fit$covariate_effects()
```

## State occupancy probabilities

For each subject, we compute the probability that they are in a given state
at time $t$.

```{r}
p_state_df <- function(fit, oos, data = NULL) {
  df <- p_state_occupancy(fit, data = data, oos = oos)
  if (is.null(data)) {
    data <- fit$data
  }
  df <- df |> left_join(data$paths$subject_df, by = "subject_id")
  df$State <- paste0(df$state_idx, ": ", df$state)
  df$sex <- as.factor(df$sex)
  df
}
df <- p_state_df(fit, oos = FALSE)
```

We plot the state occupancy probabilities, coloring by different covariate
values.

```{r, fig.width=7, fig.height=4}
# Plot by age
plt_age <- ggplot(df, aes(x = time, y = mean(prob), group = subject_id, color = age)) +
  facet_wrap(. ~ State) +
  geom_line(alpha = 0.25) +
  scale_color_viridis_c() +
  ylab("State probability")
plt_age
```


```{r, fig.width=7, fig.height=4}
# By sex
df_bysex <- df |>
  group_by(State, time, sex) |>
  summarise(p_mean = mean(mean(prob)), .groups = "drop")
plt_sex <- ggplot(df_bysex, aes(x = time, y = p_mean, group = sex, color = sex)) +
  facet_wrap(. ~ State) +
  geom_line() +
  ylab("Mean state probability")
plt_sex
```


```{r, fig.width=7, fig.height=4}
# By donor age
plt_dage <- ggplot(df, aes(x = time, y = mean(prob), group = subject_id, color = dage)) +
  facet_wrap(. ~ State) +
  geom_line(alpha = 0.25) +
  scale_color_viridis_c() +
  ylab("State probability")
plt_dage
```

## Predicting for a new subject

Here is a function for creating test data for a new subject with given
covariates and given state at time 0.

```{r}
create_test_subject <- function(state, dages = c(20, 30, 40, 50, 60, 70, 80), age = 60, sex = 0) {
  pdf <- NULL
  sdf <- NULL
  ldf <- NULL
  j <- 0
  for (dage in dages) {
    j <- j + 1
    sid <- paste0("test-", dage)
    pdf_j <- data.frame(path_id = j, state = state, time = c(0, 20), trans_idx = c(0, 1))
    sdf_j <- data.frame(subject_id = sid, age = age, dage = dage, sex = sex)
    ldf_j <- data.frame(path_id = j, draw_idx = 1, rep_idx = 1, subject_id = sid)
    pdf <- rbind(pdf, pdf_j)
    ldf <- rbind(ldf, ldf_j)
    sdf <- rbind(sdf, sdf_j)
  }

  pd <- PathData$new(sdf, pdf, ldf, fit$model$system$tm(), c("age", "dage", "sex"))
  JointData$new(paths = pd, dosing = NULL)
}
```

We can use it like this to predict the state occupancy probabilities for the same 60 years old subject with sex 0, considering what if they got the transplant
from a donor of given age.

### Starting healthy

```{r, fig.width=7, fig.height=4}
dat_test <- create_test_subject(state = 1)
df_test <- p_state_df(fit, data = dat_test, oos = TRUE)
ggplot(df_test, aes(x = time, y = mean(prob), group = subject_id, color = dage)) +
  facet_wrap(. ~ State) +
  geom_line() +
  scale_color_viridis_c() +
  ylab("State probability")
```


### Starting from Mild CAV

```{r, fig.width=7, fig.height=4}
dat_test <- create_test_subject(state = 2)
df_test <- p_state_df(fit, data = dat_test, oos = TRUE)
ggplot(df_test, aes(x = time, y = mean(prob), group = subject_id, color = dage)) +
  facet_wrap(. ~ State) +
  geom_line() +
  scale_color_viridis_c() +
  ylab("State probability")
```

### Starting from Severe CAV

```{r, fig.width=7, fig.height=4}
dat_test <- create_test_subject(state = 3)
df_test <- p_state_df(fit, data = dat_test, oos = TRUE)
ggplot(df_test, aes(x = time, y = mean(prob), group = subject_id, color = dage)) +
  facet_wrap(. ~ State) +
  geom_line() +
  scale_color_viridis_c() +
  ylab("State probability")
```

