---
title: "Multistate models in the bmstate package"
author: Juho Timonen
date: 28th July 2025
output: 
  rmarkdown::html_vignette:
    toc: true 
    toc_depth: 3
    number_sections: true
    
bibliography: references.bib
editor: source
vignette: >
  %\VignetteIndexEntry{Multistate models in the bmstate package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(bmstate)
library(ggplot2)
theme_set(theme_bw())
```


## Multistate modeling

### States and transitions

In a multistate model, we can represent
the possible *transitions* between *states* as directed edges of a graph whose
nodes correspond to states. The transitions that start from the same node are 
all at risk simultaneously when the system is in this state. The transitions
that are at risk simultaneously are
competing, meaning that occurrence of one transition censors the other ones.

```{r tmat, fig.width=5, fig.height=4.5}
tmat <- transmat_full(LETTERS[1:3])
tmat$plot()
```

```{r stprint}
tmat$states_df()
```

```{r tmatprint}
tmat$trans_df()
```

### Hazard model

For each transition $h = 1, \ldots, H$ and observation
unit $n = 1, \ldots, N$, the hazard rates $\lambda^{(h)}_n(t)$, $h = 1, \ldots, H$,
are modeled as
$$
\lambda^{(h)}_n(t) = b^{(h)}(t)\exp\left(\beta_{T_h}^{\top} \mathbf{x}_n \right)
$$

where 

- $b^{(h)}(t)$ represents the baseline hazard for transition $h$
- $T_h$ is an integer indexing the type (`trans_type`) of transition $h$
- $\beta_r^{(T_h)}$ is the respective regression coefficient for transition
type $T_h$
- $\mathbf{x}_n$ includes time-independent covariates for unit $n$

We group transitions that end in the same state together to have 
the same transition type. 


### Baseline hazards

Each log baseline hazard $\log b^{(h)}(t)$ is modeled nonparametrically
so that
$$
\log \left(b^{(h)}(t)\right) = b_0^{(h)} + B^{(h)}(t)
$$
where $b_0^{(h)}$ is a constant and $B^{(h)}(t)$ is time-dependent variation
modeled using B-splines. The knot locations for the splines are same for all
transitions, and are set based on the quantiles of all transition times.

### Priors

Currently the package uses a standard normal prior for the coefficients 
$\beta$. The prior for the weights of the spline basis functions is
set hierarchically so that transitions
of same type have a shared mean. Also the average log hazard rates
$b_0^{(h)}$ have a hierarchical prior so that transitions of the same type
have a shared mean. This prior mean is estimated from the data using a standard
Cox proportional hazards model fit.


## Event risk prediction

We often ultimately want the model to be able to predict, for a given 
observation unit, the 
probability that a particular event $E$
occurs in a specified time period of length $T$ at least once, given
an initial state $s_0$ at time $t_0$. There are
two ways to compute this probability, which we denote by $P(E \mid T, s)$.


### Path generation

For any observation unit, which does not
need to be part of the training data,
we can estimate it empirically by generating a number of paths starting from
the initial state, and computing the proportion of paths
in which the event occurred up to time $T$. For drawing the arrival times for 
a non-homogeneous Poisson process in path 
generation, we use the thinning algorithm [@lewis1979].

### Kolmogorov forward equations

If the transition matrix of the multistate model has no self-loops, it is
a continuous-time Markov process. In this special case, let
\( P_{ij}(t) \) be the probability that the process is in state \( j \) at time \( t \), given that it started in state \( i \) at time 0. The Kolmogorov forward equations are

\[
\frac{\text{d}}{\text{d}t} P_{ij}(t) = \sum_{k} P_{ik}(t) q_{kj}, \quad \text{for all } i, j
\]

where \( q_{kj} \) is the \emph{transition rate} from state \( k \) to state \( j \), and the generator matrix \( Q = [q_{kj}] \) satisfies:

\[
q_{kj} \geq 0 \quad \text{for } k \neq j, \quad \text{and} \quad q_{kk} = -\sum_{j \neq k} q_{kj}
\]


## References




