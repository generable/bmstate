---
title: "Multistate models in the bmstate package"
author: Juho Timonen
date: 29th July 2025
output: 
  rmarkdown::html_vignette:
    toc: true 
    toc_depth: 3
    number_sections: true
    
bibliography: references.bib
editor: source
vignette: >
  %\VignetteIndexEntry{Multistate models in the bmstate package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(bmstate)
library(ggplot2)
theme_set(theme_bw())
```


## Multistate modeling

### States and transitions

In a multistate model, we can represent
the possible *transitions* between *states* as directed edges of a graph whose
$S$ nodes correspond to states $s \in {1, \ldots, S}$. The transitions that 
start from the same node are 
all at risk simultaneously when the system is in this state. The transitions
that are at risk simultaneously are
competing, meaning that occurrence of one transition censors the other ones.

```{r tmat, fig.width=3.5, fig.height=3}
tmat <- transmat_full(LETTERS[1:3])
tmat$plot()
```

```{r stprint}
tmat$states_df()
```

```{r tmatprint}
tmat$trans_df()
```

### Hazard model

For each transition $h = 1, \ldots, H$ and observation
unit $n = 1, \ldots, N$, the hazard rates $\lambda^{(h)}_n(t)$, $h = 1, \ldots, H$,
are modeled as
$$
\lambda^{(h)}_n(t) = b^{(h)}(t)\exp\left(\beta_{T_h}^{\top} \mathbf{x}_n \right)
$$

where 

- $b^{(h)}(t)$ represents the baseline hazard for transition $h$
- $T_h$ is an integer indexing the type (`trans_type`) of transition $h$
- $\beta_r^{(T_h)}$ is the respective regression coefficient for transition
type $T_h$
- $\mathbf{x}_n$ includes time-independent covariates for unit $n$

We group transitions that end in the same state together to have 
the same transition type.

```{r tmat2, fig.width=3.5, fig.height=3}
tmat <- transmat_full(LETTERS[1:3])
el <- parse(text = paste0("lambda[n]^(", c(1, 3, 2, 4), ")"))
tmat$plot(edge_labs = el, edge.label.cex = 1.5)
```

### Baseline hazards

Each log baseline hazard $\log b^{(h)}(t)$ is modeled nonparametrically
so that
$$
\log \left(b^{(h)}(t)\right) = b_0^{(h)} + B^{(h)}(t)
$$
where $b_0^{(h)}$ is a constant and $B^{(h)}(t)$ is time-dependent variation
modeled using B-splines. The knot locations for the splines are same for all
transitions, and are set based on the quantiles of all transition times.

### Priors

Currently the package uses a standard normal prior for the coefficients 
$\beta$. The prior for the weights of the spline basis functions is
set hierarchically so that transitions
of same type have a shared mean. Also the average log hazard rates
$b_0^{(h)}$ have a hierarchical prior so that transitions of the same type
have a shared mean. This prior mean is estimated from the data using a standard
Cox proportional hazards model fit.


## Event risk prediction

### Events

For example if the multistate system is modeling medical patients
as observation units, 
transitioning to a state can correspond to a clinical *event*. For now,
we assume that transitioning to state $e$ means that event $e \in {1, \ldots, S}$
occurs.
We often ultimately want the model to be able to predict, for a given 
observation unit, the probability that a particular event $e$
occurs in a specified time period of length $T$ at least once, given
an initial state $s$ at time $t = 0$. We denote this probability
by $p(e \mid s, T)$.


### Path generation

For any observation unit, which does not
need to be part of the training data,
we can estimate it empirically by generating a number of paths starting from
the initial state, and computing the proportion of paths
in which $e$ occurred up to time $T$. For drawing the arrival times for 
a non-homogeneous Poisson process in path 
generation, we use the thinning algorithm [@lewis1979].

### Kolmogorov forward equations

#### Generator matrix

If the transition matrix of the multistate model has no self-loops, it is
a continuous-time Markov process [@norris1997]. In this special case, we can
define a generator matrix $\mathbf{Q}(t) = [q_{jk}(t)]$ where $q_{kj}(t)$ is called
the transition rate from state $k$ to state $j$. The
transition rate for $k \neq j$ is $0$ if the corresponding transition is not 
possible, and
otherwise it is given by the corresponding hazard function. Additionally,
\begin{equation}
q_{kk}(t) = -\sum_{j \neq k} q_{kj}(t)
\end{equation}
for all diagonal values $k \in {1, \ldots, S}$.

#### Transition probability matrix
We also define a transition probability matrix $\mathbf{P}(t) = [ P_{ij}(t) ]$ 
where $P_{ij}(t)$ be the probability that the process is in state $j$ at time $t$,
given that it started in state $i$ at time 0. The Kolmogorov forward equations 
are
\begin{equation}
\frac{\text{d}}{\text{d}t} \mathbf{P}(t) = \mathbf{P}(t) \mathbf{Q}(t)
\end{equation}
and we can solve $\mathbf{P}(t)$ using the initial condition 
$\mathbf{P}(0) = I$. For terminal states, we have $p(e \mid s, T) = P_{se}(T)$.

## References




