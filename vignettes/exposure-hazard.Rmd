---
title: "Exposure-hazard multistate modeling with bmstate"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Exposure-hazard multistate modeling with bmstate}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Data simulation

## Setup

```{r setup}
library(bmstate)
library(dplyr)
library(tidyr)
library(tibble)
library(ggplot2)
```

```{r}
# Setup
params <- list(
  N_subject = 600,
  iter_warmup = 800,
  iter_sampling = 400,
  chains = 1
)

# Names of event states
event_state_names <- function(model) {
  tm <- model$system$tm()
  tm$states_df() |>
    filter(!source) |>
    pull(state)
}
```

## True data-generating model

```{r}
# True beta
create_true_covariate_effects <- function(mod) {
  NTT <- mod$system$num_states() - 1
  C <- length(mod$covs())
  bh_true <- matrix(0, NTT, C)
  bh_true[1, 2] <- 1
  bh_true[2, 2] <- -1
  bh_true[3, 1] <- 0.3
  sn <- event_state_names(mod)
  rownames(bh_true) <- paste0("Effect on ", sn)
  colnames(bh_true) <- mod$covs()
  df <- data.frame(bh_true) |>
    rownames_to_column("event") |>
    pivot_longer(cols = -event, names_to = "covariate", values_to = "beta")
  list(df = df, matrix = bh_true)
}

# True baseline hazard parameters
create_true_baseline_hazard <- function(mod) {
  tm <- mod$system$tm()

  # Spline weights
  w_true <- matrix(0, 7, 9)
  for (j in 1:7) {
    ww <- rep(0, 9)
    if (tm$trans_df()$trans_type[j] == 2) {
      ww <- rep(-1, 9)
      ww[3:5] <- 1
    }
    if (tm$trans_df()$trans_type[j] == 3) {
      ww <- rep(-1, 9)
      ww[4:8] <- 1
    }
    w_true[j, ] <- ww
  }

  # Intercept
  w0_true <- 0.5 * 1e-3
  w0_true_vec <- rep(w0_true, 7)
  w0_true_vec[3] <- 0.1 * w0_true
  w0_true_vec[5] <- 5 * w0_true
  w0_true_vec[7] <- 20 * w0_true

  # Return
  list(w0 = w0_true_vec, w = w_true)
}

# True data-generating model
create_true_model <- function() {
  # Create models
  sn <- c("Healthy", "Bleed", "Stroke", "Dead")
  tm <- transmat_diamond(state_names = sn)
  t3yr <- 3 * 365.25
  haz_covs <- c("age")
  pk_covs <- list(
    CL = c("CrCL", "age"), V2 = "weight"
  )
  create_msm(
    tm,
    hazard_covs = haz_covs, pk_covs = pk_covs, num_knots = 8, t_max = t3yr
  )
}

# Create rvars
create_true_draws <- function(sim) {
  w <- array(0, dim = c(1, 1, 7, 9))
  w[1, 1, , ] <- sim$w_true
  w <- posterior::rvar(w)
  log_w0 <- array(0, dim = c(1, 1, 7))
  log_w0[1, , ] <- log(sim$df_true_h0$h0_true)
  log_w0 <- posterior::rvar(log_w0)

  beta_oth <- array(0, dim = c(1, 1, 2, 3))
  bb <- cbind(
    sim$df_true_beta |>
      filter(covariate == "age") |> pull(beta),
    sim$df_true_beta |>
      filter(covariate == "dose_amt") |> pull(beta)
  )
  beta_oth[1, 1, , ] <- t(bb)
  beta_oth <- posterior::rvar(beta_oth)
  S <- posterior::ndraws(beta_oth)

  # Create rvar list
  list(
    beta_oth = beta_oth,
    weights = w,
    log_w0 = log_w0,
    lp__ = posterior::rvar(array(0, dim = c(S, 1)))
  )
}
```

## Data simulation

```{r}
mod_true <- create_true_model()
beta_true <- create_true_covariate_effects(mod_true)
h0_true <- create_true_baseline_hazard(mod_true)
simdat <- mod_true$simulate_data(
  params$N_subject,
  beta_haz = beta_true$matrix,
  w0 = h0_true$w0,
  w = h0_true$w
)
```

# Modeling

## Defining models


```{r}
covs_dh <- unique(c(mod_true$data_covs(), "dose_amt"))
NK <- 4
tm <- mod_true$system$tm()
pk_covs <- list(
  ka = mod_true$pk_model$ka_covs(),
  CL = mod_true$pk_model$CL_covs(),
  V2 = mod_true$pk_model$V2_covs()
)

# Exposure-hazard multistate model
mod_ms_eh <- create_msm(
  tm,
  hazard_covs = setdiff(mod_true$covs(), "ss_auc"),
  pk_covs = pk_covs,
  num_knots = NK, t_max = mod_true$get_tmax()
)

# Dose-hazard multistate model
mod_ms_dh <- create_msm(
  tm,
  hazard_covs = covs_dh, num_knots = NK, t_max = mod_true$get_tmax()
)

# Survival model
tm0 <- transmat_survival(tm$states[c(1, 4)])
mod_death <- create_msm(
  tm0,
  hazard_covs = covs_dh, num_knots = NK, t_max = mod_true$get_tmax()
)
```

```{r}
# Inference model knots
t3yr <- mod_true$get_tmax()
tt <- simdat$paths$transition_times()
mod_ms_eh$set_knots(t3yr, tt, NK)
mod_ms_dh$set_knots(t3yr, tt, NK)
mod_death$set_knots(t3yr, tt, NK)

# Oracle fit
fit_true <- fit_stan(mod_true, simdat, chains = 1, iter_warmup = 60, iter_sampling = 60)
td <- create_true_draws(sim)
fit_true <- MultistateModelFit$new(fit_true$data, fit_true$get_data(), mod_true, td)
```

```{r}
# Fit the models
fit_ms_eh <- fit_stan(mod_ms_eh, simdat, method = "pathfinder")
fit_ms_dh <- fit_stan(mod_ms_dh, simdat, method = "pathfinder")

fit_death <- fit_stan(mod_death, sim$train_data_death, method = "pathfinder")
```
